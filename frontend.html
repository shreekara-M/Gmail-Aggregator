<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Gmail Aggregator</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: #f8fafc;
        height: 100vh;
        overflow: hidden;
      }

      .dashboard {
        display: flex;
        height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 300px;
        background: #1f2937;
        color: white;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #374151;
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #374151;
      }

      .sidebar-header h2 {
        color: white;
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 15px;
      }

      .search-container {
        position: relative;
      }

      .search-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #4b5563;
        border-radius: 8px;
        background: #374151;
        color: white;
        font-size: 14px;
      }

      .search-input::placeholder {
        color: #9ca3af;
      }

      .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      }

      .users-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px 0;
      }

      .user-item {
        padding: 15px 20px;
        cursor: pointer;
        border-bottom: 1px solid #374151;
        transition: background-color 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-item:hover {
        background-color: #374151;
      }

      .user-item.active {
        background-color: #3b82f6;
      }

      .user-name {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 2px;
      }

      .user-email {
        font-size: 12px;
        color: #9ca3af;
      }

      .user-badge {
        background: #ef4444;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .user-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .delete-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: background 0.2s;
        opacity: 0.8;
      }

      .delete-btn:hover {
        background: #dc2626;
        opacity: 1;
      }

      .user-item:hover .delete-btn {
        opacity: 1;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #f8fafc;
      }

      /* Top Navigation */
      .navbar {
        background: white;
        padding: 15px 25px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .navbar-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .navbar-right {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .mode-toggle {
        display: flex;
        background: #f3f4f6;
        border-radius: 8px;
        overflow: hidden;
      }

      .mode-toggle button {
        padding: 8px 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
      }

      .mode-toggle button.active {
        background: #3b82f6;
        color: white;
      }

      .recruiter-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f3f4f6;
        padding: 8px 12px;
        border-radius: 8px;
      }

      .recruiter-toggle input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .recruiter-toggle label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
      }

      .add-user-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        text-decoration: none;
        transition: background 0.2s;
      }

      .add-user-btn:hover {
        background: #2563eb;
      }

      .refresh-btn {
        background: #10b981;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: background 0.2s;
      }

      .refresh-btn:hover {
        background: #059669;
      }

      /* Content Area */
      .content-area {
        flex: 1;
        padding: 25px;
        overflow-y: auto;
      }

      .user-emails-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .user-emails-header {
        padding: 20px 25px;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
      }

      .user-emails-header h3 {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 5px;
      }

      .user-emails-header p {
        color: #6b7280;
        font-size: 14px;
      }

      .emails-table-container {
        flex: 1;
        overflow-y: auto;
        max-height: calc(100vh - 200px);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        border: 1px solid #e5e7eb;
        padding: 12px;
        text-align: left;
        font-size: 14px;
        color: #374151;
        word-break: break-word;
      }

      th {
        background-color: #f9fafb;
        color: #374151;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
        border-bottom: 2px solid #e5e7eb;
      }

      tr:nth-child(even) {
        background-color: #f9fafb;
      }

      tr:hover {
        background-color: #e0f2fe;
      }

      .error {
        color: #b91c1c;
        font-weight: 600;
        margin: 20px;
        padding: 15px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
      }

      .warning {
        color: #f59e0b;
        font-weight: 500;
        margin: 20px;
        padding: 15px;
        background: #fffbeb;
        border: 1px solid #fed7aa;
        border-radius: 8px;
      }

      .no-user-selected {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6b7280;
        text-align: center;
      }

      .no-user-selected h3 {
        font-size: 24px;
        margin-bottom: 10px;
        color: #9ca3af;
      }

      .no-user-selected p {
        font-size: 16px;
      }

      /* Loading overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.85);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 1000;
      }

      .spinner {
        border: 6px solid #eee;
        border-top: 6px solid #2563eb;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          width: 250px;
        }
        
        .navbar {
          padding: 10px 15px;
        }
        
        .content-area {
          padding: 15px;
        }
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const emailToName = {
        "ananthpai34402@gmail.com": "Ananth Pai B H",
        "arpitha68341@gmail.com": "Arpitha K K ",
        "bhagyashree47325@gmail.com": "Bhagyashree Girish ",
        "deepika07205@gmail.com": "Deepika V",
        "jagdish14267@gmail.com": "Jagdish Siddaiah",
        "karthikputhran61469@gmail.com": "Karthik Puthran",
        "lavanya07744@gmail.com": "Lavanya A S",
        "manikantaraju33002@gmail.com": "Manikantha Raju",
        "megha22467@gmail.com": "Megha B ",
        "ramachandra63850@gmail.com": "Ramachandra JP",
        "sharaths7511@gmail.com": "Sharath S",
      };

      const recruiterDomains = [
        "hirist.tech",
        "naukri.com",
        "linkedin.com",
        "indeed.com",
        "glassdoor.com"
      ];

      function EmailTable({ messages, showOnlyRecruiters }) {
        const filteredMessages = showOnlyRecruiters
          ? messages.filter(message => {
              const fromEmail = message.from || "";
              return recruiterDomains.some(domain => 
                fromEmail.toLowerCase().includes(domain.toLowerCase())
              );
            })
          : messages;

        return (
          <div className="emails-table-container">
            <table>
              <thead>
                <tr>
                  <th>From</th>
                  <th>Subject</th>
                  <th>Date</th>
                  <th>Snippet</th>
                </tr>
              </thead>
              <tbody>
                {filteredMessages.map((message, index) => (
                  <tr key={index}>
                    <td>{message.from || ""}</td>
                    <td>{message.subject || ""}</td>
                    <td>{message.date || ""}</td>
                    <td>{message.snippet || ""}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      function UserSidebar({ accounts, selectedUser, onUserSelect, searchQuery, onSearchChange, onDeleteUser }) {
        const filteredAccounts = accounts.filter(account => {
          const name = emailToName[account.email] || account.email;
          const email = account.email;
          const query = searchQuery.toLowerCase();
          return name.toLowerCase().includes(query) || email.toLowerCase().includes(query);
        });

        const handleDeleteClick = (e, account) => {
          e.stopPropagation(); // Prevent user selection when clicking delete
          if (window.confirm(`Are you sure you want to delete ${emailToName[account.email] || account.email}?`)) {
            onDeleteUser(account.email);
          }
        };

        return (
          <div className="sidebar">
            <div className="sidebar-header">
              <h2>Users</h2>
              <div className="search-container">
                <input
                  type="text"
                  className="search-input"
                  placeholder="Search users..."
                  value={searchQuery}
                  onChange={(e) => onSearchChange(e.target.value)}
                />
              </div>
            </div>
            <div className="users-list">
              {filteredAccounts.map((account, index) => (
                <div
                  key={index}
                  className={`user-item ${selectedUser?.email === account.email ? 'active' : ''}`}
                  onClick={() => onUserSelect(account)}
                >
                  <div>
                    <div className="user-name">
                      {emailToName[account.email] || account.email}
                    </div>
                    <div className="user-email">{account.email}</div>
                  </div>
                  <div className="user-actions">
                    <div className="user-badge">
                      {account.count || 0}
                    </div>
                    <button
                      className="delete-btn"
                      onClick={(e) => handleDeleteClick(e, account)}
                      title="Delete user"
                    >
                      ×
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      function UserEmails({ selectedUser, showOnlyRecruiters }) {
        if (!selectedUser) {
          return (
            <div className="no-user-selected">
              <h3>Select a User</h3>
              <p>Choose a user from the sidebar to view their emails</p>
            </div>
          );
        }

        const filteredMessages = showOnlyRecruiters
          ? (selectedUser.messages || []).filter(message => {
              const fromEmail = message.from || "";
              return recruiterDomains.some(domain => 
                fromEmail.toLowerCase().includes(domain.toLowerCase())
              );
            })
          : (selectedUser.messages || []);

        return (
          <div className="user-emails-container">
            <div className="user-emails-header">
              <h3>{emailToName[selectedUser.email] || selectedUser.email}</h3>
              <p>
                {showOnlyRecruiters 
                  ? `${filteredMessages.length} recruiter emails` 
                  : `${selectedUser.count || 0} total emails`
                }
              </p>
            </div>
            
            {selectedUser.error ? (
              <div className="error">{selectedUser.error}</div>
            ) : (
              <>
                {selectedUser.warning && (
                  <div className="warning">⚠️ {selectedUser.warning}</div>
                )}
                <EmailTable 
                  messages={selectedUser.messages || []} 
                  showOnlyRecruiters={showOnlyRecruiters}
                />
              </>
            )}
          </div>
        );
      }

      // Local Storage Cache Management
      const CACHE_KEY = 'gmail_cache';
      const CACHE_EXPIRY = 5 * 60 * 1000; // 5 minutes

      const getCachedData = (mode) => {
        try {
          const cached = localStorage.getItem(`${CACHE_KEY}_${mode}`);
          if (cached) {
            const data = JSON.parse(cached);
            const now = Date.now();
            if (now - data.timestamp < CACHE_EXPIRY) {
              console.log('Using cached data for', mode);
              return data.accounts;
            } else {
              console.log('Cache expired for', mode);
              localStorage.removeItem(`${CACHE_KEY}_${mode}`);
            }
          }
        } catch (error) {
          console.error('Error reading from cache:', error);
        }
        return null;
      };

      const setCachedData = (mode, accounts) => {
        try {
          const cacheData = {
            accounts,
            timestamp: Date.now()
          };
          localStorage.setItem(`${CACHE_KEY}_${mode}`, JSON.stringify(cacheData));
          console.log('Data cached for', mode);
        } catch (error) {
          console.error('Error saving to cache:', error);
        }
      };

      const removeUserFromCache = (mode, userEmail) => {
        try {
          const cached = localStorage.getItem(`${CACHE_KEY}_${mode}`);
          if (cached) {
            const data = JSON.parse(cached);
            data.accounts = data.accounts.filter(account => account.email !== userEmail);
            localStorage.setItem(`${CACHE_KEY}_${mode}`, JSON.stringify(data));
            console.log('User removed from cache:', userEmail);
            return data.accounts;
          }
        } catch (error) {
          console.error('Error updating cache:', error);
        }
        return null;
      };

      const clearCache = () => {
        try {
          localStorage.removeItem(`${CACHE_KEY}_unread`);
          localStorage.removeItem(`${CACHE_KEY}_latest`);
          console.log('Cache cleared');
        } catch (error) {
          console.error('Error clearing cache:', error);
        }
      };

      function App() {
        const [mode, setMode] = useState(null);
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(false);
        const [showOnlyRecruiters, setShowOnlyRecruiters] = useState(false);
        const [selectedUser, setSelectedUser] = useState(null);
        const [searchQuery, setSearchQuery] = useState("");

        const loadData = async (forceRefresh = false) => {
          if (!mode) return;

          // Check cache first if not forcing refresh
          if (!forceRefresh) {
            const cachedAccounts = getCachedData(mode);
            if (cachedAccounts) {
              setData({ accounts: cachedAccounts });
              // Auto-select first user if none selected
              if (cachedAccounts.length > 0 && !selectedUser) {
                setSelectedUser(cachedAccounts[0]);
              }
              return;
            }
          }

          setLoading(true);
          try {
            // Use relative URL for production deployment
            const baseUrl = window.location.origin;
            const res = await fetch(`${baseUrl}/${mode}?max=100`);
            const responseData = await res.json();
            console.log("Backend data:", responseData);
            
            // Cache the data
            if (responseData.accounts) {
              setCachedData(mode, responseData.accounts);
            }
            
            setData(responseData);
            // Auto-select first user if none selected
            if (responseData.accounts && responseData.accounts.length > 0 && !selectedUser) {
              setSelectedUser(responseData.accounts[0]);
            }
          } catch (err) {
            console.error(err);
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => {
          if (mode) {
            loadData();
          }
        }, [mode]);

        const handleModeChange = (newMode) => {
          setMode(newMode);
          setSelectedUser(null); // Reset selection when mode changes
        };

        const handleRefresh = () => {
          loadData(true); // Force refresh, bypass cache
        };

        const handleUserSelect = (user) => {
          setSelectedUser(user);
        };

        const handleSearchChange = (query) => {
          setSearchQuery(query);
        };

        const handleDeleteUser = async (email) => {
          try {
            const response = await fetch('/delete_user', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ email }),
            });

            const result = await response.json();

            if (response.ok) {
              // Remove user from local cache instead of refetching
              const updatedAccounts = removeUserFromCache(mode, email);
              
              if (updatedAccounts) {
                setData({ accounts: updatedAccounts });
              }
              
              // If the deleted user was selected, clear selection
              if (selectedUser?.email === email) {
                setSelectedUser(null);
              }
              
              alert(`User ${email} deleted successfully`);
            } else {
              alert(`Error deleting user: ${result.error}`);
            }
          } catch (error) {
            console.error('Error deleting user:', error);
            alert('Error deleting user. Please try again.');
          }
        };

        return (
          <div className="dashboard">
            <UserSidebar
              accounts={data?.accounts || []}
              selectedUser={selectedUser}
              onUserSelect={handleUserSelect}
              searchQuery={searchQuery}
              onSearchChange={handleSearchChange}
              onDeleteUser={handleDeleteUser}
            />
            
            <div className="main-content">
              <div className="navbar">
                <div className="navbar-left">
                  <div className="mode-toggle">
                    <button
                      className={mode === "unread" ? "active" : ""}
                      onClick={() => handleModeChange("unread")}
                    >
                      Unread
                    </button>
                    <button
                      className={mode === "latest" ? "active" : ""}
                      onClick={() => handleModeChange("latest")}
                    >
                      Latest
                    </button>
                  </div>
                  
                  {mode && (
                    <div className="recruiter-toggle">
                      <input
                        type="checkbox"
                        id="recruiter-filter"
                        checked={showOnlyRecruiters}
                        onChange={(e) => setShowOnlyRecruiters(e.target.checked)}
                      />
                      <label htmlFor="recruiter-filter">
                        Show Only Recruiter Mails
                      </label>
                    </div>
                  )}
                </div>
                
                <div className="navbar-right">
                  {mode && (
                    <>
                      <button className="refresh-btn" onClick={handleRefresh}>
                        Refresh
                      </button>
                      <button 
                        className="refresh-btn" 
                        onClick={() => {
                          clearCache();
                          loadData(true);
                          alert('Cache cleared and data refreshed');
                        }}
                        style={{background: '#f59e0b'}}
                        title="Clear cache and refresh"
                      >
                        Clear Cache
                      </button>
                    </>
                  )}
                  <a href="/add_user" className="add-user-btn">
                    Add User
                  </a>
                </div>
              </div>
              
              <div className="content-area">
                <UserEmails
                  selectedUser={selectedUser}
                  showOnlyRecruiters={showOnlyRecruiters}
                />
              </div>
            </div>

            {loading && (
              <div className="loading-overlay">
                <div className="spinner"></div>
                <p>Loading...</p>
              </div>
            )}
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>
